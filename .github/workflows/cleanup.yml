name: Global Org Cleanup

on:
  workflow_dispatch:

jobs:
  cleanup-all-repos:
    runs-on: ubuntu-latest
    steps:
      - name: Clean All Repositories
        env:
          GH_TOKEN: ${{ secrets.ORG_CLEANUP_TOKEN_RAUL }} 
          ORG_NAME: "liftelimasd"
          KEEP_MIN: 3
        run: |
          if [ -z "$GH_TOKEN" ]; then
            echo "::error::GH_TOKEN is empty. Check your secrets!"
            exit 1
          fi
          
          echo "Fetching repositories for organization $ORG_NAME..."
          REPOS=$(gh api "orgs/$ORG_NAME/repos" --paginate -q '.[].full_name')
          
          TOTAL_DELETED_ALL=0
          
          for REPO in $REPOS; do
            echo "---------------------------------------------------"
            echo "Checking repository: $REPO"
            
            # Fetch ALL runs for the repo
            # Output format: workflow_id run_id
            RUNS_DATA=$(gh api "repos/$REPO/actions/runs?per_page=100" --paginate -q '.workflow_runs[] | "\(.workflow_id) \(.id)"' 2>/dev/null || echo "")
            
            if [ -z "$RUNS_DATA" ]; then
               echo "  No runs found or access denied."
               continue
            fi
            
            # Get unique workflow IDs from the data
            WIDS=$(echo "$RUNS_DATA" | awk '{print $1}' | sort -u)
            
            for WID in $WIDS; do
               # Grep runs for this WID (they come sorted by time desc from API usually, but let's trust API order)
               # We just extract the IDs for this WID
               RUN_IDS=$(echo "$RUNS_DATA" | awk -v w="$WID" '$1 == w {print $2}')
               
               COUNT=0
               for RID in $RUN_IDS; do
                 COUNT=$((COUNT+1))
                 if [ "$COUNT" -gt "$KEEP_MIN" ]; then
                   echo "  Deleting run $RID (Workflow $WID)..."
                   gh api "repos/$REPO/actions/runs/$RID" -X DELETE >/dev/null 2>&1
                   TOTAL_DELETED_ALL=$((TOTAL_DELETED_ALL+1))
                 fi
               done
               
               if [ "$COUNT" -gt "$KEEP_MIN" ]; then
                  DELETED=$((COUNT - KEEP_MIN))
                  echo "    Workflow $WID: Found $COUNT runs. Deleted $DELETED."
               else
                  echo "    Workflow $WID: Found $COUNT runs. Kept all."
               fi
            done
          done
          
          echo "### ðŸ§¹ Global Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "Total runs deleted across organization: **$TOTAL_DELETED_ALL**" >> $GITHUB_STEP_SUMMARY
