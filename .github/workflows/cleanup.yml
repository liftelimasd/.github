name: Global Org Cleanup

on:
  workflow_dispatch:

jobs:
  cleanup-all-repos:
    runs-on: ubuntu-latest
    steps:
      - name: Clean All Repositories
        env:
          GH_TOKEN: ${{ secrets.ORG_CLEANUP_TOKEN_RAUL }} 
          ORG_NAME: "liftelimasd"
          KEEP_TOTAL: 3
        run: |
          if [ -z "$GH_TOKEN" ]; then
            echo "::error::GH_TOKEN is empty. Check your secrets!"
            exit 1
          fi
          
          echo "Fetching repositories for organization $ORG_NAME..."
          REPOS=$(gh api "orgs/$ORG_NAME/repos" --paginate -q '.[].full_name')
          
          TOTAL_DELETED_ALL=0
          
          for REPO in $REPOS; do
            echo "---------------------------------------------------"
            echo "Checking repository: $REPO"
            
            # Fetch ALL runs for the repo, sorted by created_at desc (default API behavior)
            # We just need the list of IDs in order
            RUN_IDS=$(gh api "repos/$REPO/actions/runs?per_page=100" --paginate -q '.workflow_runs[].id' 2>/dev/null || echo "")
            
            if [ -z "$RUN_IDS" ]; then
               echo "  No runs found or access denied."
               continue
            fi
            
            COUNT=0
            DELETED_REPO=0
            
            for RID in $RUN_IDS; do
              COUNT=$((COUNT+1))
              if [ "$COUNT" -gt "$KEEP_TOTAL" ]; then
                echo "  Deleting run $RID..."
                gh api "repos/$REPO/actions/runs/$RID" -X DELETE >/dev/null 2>&1
                TOTAL_DELETED_ALL=$((TOTAL_DELETED_ALL+1))
                DELETED_REPO=$((DELETED_REPO+1))
              fi
            done
            
            if [ "$DELETED_REPO" -gt 0 ]; then
               echo "  Deleted $DELETED_REPO runs. Kept top $KEEP_TOTAL."
            else
               echo "  Already clean (Found $COUNT runs)."
            fi
          done
          
          echo "### ðŸ§¹ Global Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "Total runs deleted across organization: **$TOTAL_DELETED_ALL**" >> $GITHUB_STEP_SUMMARY
