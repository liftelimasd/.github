name: Global Org Cleanup

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  cleanup-all-repos:
    runs-on: ubuntu-latest
    steps:
      - name: Clean All Repositories
        env:
          GH_TOKEN: ${{ secrets.ORG_CLEANUP_TOKEN_RAUL }} 
          ORG_NAME: "liftelimasd"
          KEEP_MIN: 3
        run: |
          # Explicitly login to ensure token is picked up
          echo "$GH_TOKEN" | gh auth login --with-token
          
          echo "Fetching repositories for organization $ORG_NAME..."
          
          REPOS=$(gh api "orgs/$ORG_NAME/repos" --paginate -q '.[].full_name')
          
          TOTAL_DELETED_ALL=0
          
          for REPO in $REPOS; do
            echo "---------------------------------------------------"
            echo "Checking repository: $REPO"
            
            WORKFLOWS=$(gh api "repos/$REPO/actions/workflows" -q '.workflows[].id' 2>/dev/null || echo "")
            
            if [ -z "$WORKFLOWS" ]; then
              echo "  No workflows found or access denied."
              continue
            fi
            
            for WID in $WORKFLOWS; do
               RUNS=$(gh api "repos/$REPO/actions/workflows/$WID/runs?per_page=100" --paginate -q '.workflow_runs[].id')
               
               COUNT=0
               for RID in $RUNS; do
                 COUNT=$((COUNT+1))
                 if [ "$COUNT" -gt "$KEEP_MIN" ]; then
                   echo "  Deleting run $RID from $REPO..."
                   gh api "repos/$REPO/actions/runs/$RID" -X DELETE >/dev/null 2>&1
                   TOTAL_DELETED_ALL=$((TOTAL_DELETED_ALL+1))
                 fi
               done
            done
          done
          
          echo "### ðŸ§¹ Global Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "Total runs deleted across organization: **$TOTAL_DELETED_ALL**" >> $GITHUB_STEP_SUMMARY
