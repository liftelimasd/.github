name: Global Org Cleanup

on:
  workflow_dispatch:

jobs:
  cleanup-all-repos:
    runs-on: ubuntu-latest
    steps:
      - name: Clean All Repositories
        env:
          GH_TOKEN: ${{ secrets.ORG_CLEANUP_TOKEN_RAUL }} 
          ORG_NAME: "liftelimasd"
          KEEP_MIN: 3
        run: |
          if [ -z "$GH_TOKEN" ]; then
            echo "::error::GH_TOKEN is empty. Check your secrets!"
            exit 1
          fi
          
          # Explicitly login removed as GH_TOKEN env var is sufficient
          
          echo "Fetching repositories for organization $ORG_NAME..."
          
          REPOS=$(gh api "orgs/$ORG_NAME/repos" --paginate -q '.[].full_name')
          
          TOTAL_DELETED_ALL=0
          
          for REPO in $REPOS; do
            echo "---------------------------------------------------"
            echo "Checking repository: $REPO"
            
            WORKFLOWS=$(gh api "repos/$REPO/actions/workflows" -q '.workflows[].id' 2>/dev/null || echo "")
            
            if [ -z "$WORKFLOWS" ]; then
              echo "  No workflows found or access denied."
              continue
            fi
            
            for WID in $WORKFLOWS; do
               # Get all runs for this workflow
               # Using --paginate to fetch ALL pages
               RUNS=$(gh api "repos/$REPO/actions/workflows/$WID/runs?per_page=100" --paginate -q '.workflow_runs[].id')
               
               # Calculate total runs (handling empty string case)
               if [ -z "$RUNS" ]; then
                  RUN_COUNT=0
               else
                  RUN_COUNT=$(echo "$RUNS" | wc -w)
               fi
               
               echo "    Workflow $WID: Found $RUN_COUNT runs (Keeping top $KEEP_MIN)"
               
               COUNT=0
               for RID in $RUNS; do
                 COUNT=$((COUNT+1))
                 if [ "$COUNT" -gt "$KEEP_MIN" ]; then
                   echo "  Deleting run $RID from $REPO..."
                   gh api "repos/$REPO/actions/runs/$RID" -X DELETE >/dev/null 2>&1
                   TOTAL_DELETED_ALL=$((TOTAL_DELETED_ALL+1))
                 fi
               done
            done
          done
          
          echo "### ðŸ§¹ Global Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "Total runs deleted across organization: **$TOTAL_DELETED_ALL**" >> $GITHUB_STEP_SUMMARY
