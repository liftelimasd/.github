name: Global Org Cache Cleanup

on:
  workflow_dispatch:

jobs:
  cleanup-all-repos-caches:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write

    steps:
      - name: Clean Actions Cache in All Repositories
        env:
          GH_TOKEN: ${{ secrets.ORG_CLEANUP_TOKEN_RAUL }}
          ORG_NAME: "liftelimasd"
          KEEP_TOTAL: 0   # —Å–∫–æ–ª—å–∫–æ —Å–∞–º—ã—Ö –Ω–æ–≤—ã—Ö cache-entries –æ—Å—Ç–∞–≤–∏—Ç—å –≤ –∫–∞–∂–¥–æ–º —Ä–µ–ø–æ (0 = —É–¥–∞–ª–∏—Ç—å –≤—Å–µ)
        run: |
          set -euo pipefail

          if [ -z "${GH_TOKEN:-}" ]; then
            echo "::error::GH_TOKEN is empty. Check your secrets!"
            exit 1
          fi

          echo "Fetching repositories for organization $ORG_NAME..."
          REPOS=$(gh api "orgs/$ORG_NAME/repos" --paginate -q '.[].full_name')

          TOTAL_DELETED_ALL=0
          TOTAL_FREED_BYTES_ALL=0

          for REPO in $REPOS; do
            echo "---------------------------------------------------"
            echo "Checking repository: $REPO"

            # –°–æ–±–∏—Ä–∞–µ–º –∫—ç—à–∏ –ø–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–æ. –§–æ—Ä–º–∞—Ç: created_at \t id \t size_in_bytes \t key
            CACHE_LINES=$(
              gh api "repos/$REPO/actions/caches?per_page=100" --paginate \
                -q '.actions_caches[] | "\(.created_at)\t\(.id)\t\(.size_in_bytes)\t\(.key)"' 2>/dev/null || true
            )

            if [ -z "${CACHE_LINES:-}" ]; then
              echo "  No caches found or access denied."
              continue
            fi

            # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ created_at (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
            SORTED=$(printf "%s\n" "$CACHE_LINES" | sort -r)

            COUNT=0
            DELETED_REPO=0
            FREED_BYTES_REPO=0

            while IFS=$'\t' read -r CREATED CACHE_ID SIZE KEY; do
              COUNT=$((COUNT+1))

              if [ "$COUNT" -gt "$KEEP_TOTAL" ]; then
                echo "  Deleting cache id=$CACHE_ID key=$KEY created_at=$CREATED size=${SIZE}B ..."
                gh api "repos/$REPO/actions/caches/$CACHE_ID" -X DELETE >/dev/null 2>&1 || {
                  echo "  ::warning::Failed to delete cache $CACHE_ID (maybe permissions / already gone)."
                  continue
                }

                TOTAL_DELETED_ALL=$((TOTAL_DELETED_ALL+1))
                DELETED_REPO=$((DELETED_REPO+1))

                # SIZE –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º/–Ω–µ—á–∏—Å–ª–æ–º –≤ —Ä–µ–¥–∫–∏—Ö —Å–ª—É—á–∞—è—Ö ‚Äî —Å—Ç—Ä–∞—Ö—É–µ–º—Å—è
                if [[ "$SIZE" =~ ^[0-9]+$ ]]; then
                  FREED_BYTES_REPO=$((FREED_BYTES_REPO+SIZE))
                  TOTAL_FREED_BYTES_ALL=$((TOTAL_FREED_BYTES_ALL+SIZE))
                fi
              fi
            done <<< "$SORTED"

            if [ "$DELETED_REPO" -gt 0 ]; then
              echo "  Deleted $DELETED_REPO caches. Kept top $KEEP_TOTAL."
              echo "  Freed (approx): $FREED_BYTES_REPO bytes"
            else
              echo "  Already clean (Found $COUNT caches)."
            fi
          done

          FREED_MB=$(awk "BEGIN {printf \"%.2f\", $TOTAL_FREED_BYTES_ALL/1024/1024}")

          echo "### üßπ Global Cache Cleanup Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "Total caches deleted across organization: **$TOTAL_DELETED_ALL**" >> "$GITHUB_STEP_SUMMARY"
          echo "Approx freed space: **${FREED_MB} MB**" >> "$GITHUB_STEP_SUMMARY"
          echo "Kept per repo: **$KEEP_TOTAL** newest cache entries" >> "$GITHUB_STEP_SUMMARY"
