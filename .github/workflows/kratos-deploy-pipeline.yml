# FILE: .github/workflows/kratos-deploy-pipeline.yml 
name: Kratos Reusable Pipeline

on:
  workflow_call:
    inputs:
      version:
        required: false
        type: string
    secrets:
      REGISTRY_LOGIN:
        required: true
      REGISTRY_PASS:
        required: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Project
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare Info
        id: info
        run: |
          # 1. Determine Version
          VERSION="${{ inputs.version }}"
          if [ -z "$VERSION" ] || [ "$VERSION" == "latest" ]; then
            git fetch --tags --force > /dev/null 2>&1
            LATEST_TAG=$(git tag --sort=-v:refname | head -n 1)
            if [ -z "$LATEST_TAG" ]; then
              VERSION="v0.0.1"
            else
              VERSION="$LATEST_TAG"
            fi
          fi
          
          # 2. Parse Service Config
          SERVICE_NAME=$(grep 'name:' service/configs/config.yaml | awk '{print $2}')
          [ -z "$SERVICE_NAME" ] && SERVICE_NAME="service"
          
          PORTS=$(grep 'addr:' service/configs/config.yaml | awk -F: '{print $NF}' | tr '\n' ' ' | xargs)
          [ -z "$PORTS" ] && PORTS="3000 3001"
          
          # 3. Clean Version & Time
          CLEAN_VERSION="${VERSION#v}"
          TIME_FMT=$(date +'%d-%m-%Y %H:%M')
          
          REGISTRY="registry.liftel.es:5000"
          IMAGE="${REGISTRY}/${SERVICE_NAME}:${CLEAN_VERSION}"
          
          echo "version=${CLEAN_VERSION}" >> $GITHUB_OUTPUT
          echo "timestamp=${TIME_FMT}" >> $GITHUB_OUTPUT
          echo "ports=${PORTS}" >> $GITHUB_OUTPUT
          echo "image=${IMAGE}" >> $GITHUB_OUTPUT
          echo "registry=${REGISTRY}" >> $GITHUB_OUTPUT

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Docker Login
        uses: docker/login-action@v3
        with:
          registry: ${{ steps.info.outputs.registry }}
          username: ${{ secrets.REGISTRY_LOGIN }}
          password: ${{ secrets.REGISTRY_PASS }}

      - name: Generate Dockerfile
        run: |
          cat <<EOF > Dockerfile
          FROM golang:1.24 AS builder
          WORKDIR /src
          COPY service/ .
          RUN go mod download
          RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o /app/service ./cmd/service

          FROM gcr.io/distroless/static:nonroot
          WORKDIR /app
          COPY --from=builder /app/service .
          COPY service/configs/config.yaml /configs/config.yaml
          EXPOSE ${{ steps.info.outputs.ports }}
          ENTRYPOINT ["/app/service"]
          CMD ["-conf", "/configs"]
          EOF

      - name: Build and Push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          push: true
          tags: ${{ steps.info.outputs.image }}
          provenance: false

      - name: Deploy Summary
        if: always()
        run: |
          echo "### ðŸ“¦ Deploy Info" > $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          echo "| **Time** | ${{ steps.info.outputs.timestamp }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | ${{ steps.info.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Image** | \`${{ steps.info.outputs.image }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Ports** | ${{ steps.info.outputs.ports }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then
             echo "âœ… **Build & Push Successful**" >> $GITHUB_STEP_SUMMARY
          else
             echo "âŒ **Build & Push Failed**" >> $GITHUB_STEP_SUMMARY
          fi
