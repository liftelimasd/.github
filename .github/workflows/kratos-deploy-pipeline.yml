# FILE: .github/workflows/kratos-deploy-pipeline.yml
name: Kratos Reusable Pipeline

on:
  workflow_call:
    inputs:
      version:
        required: false
        type: string
      copy_env:
        description: 'Copy .env from secrets into image?'
        required: false
        type: boolean
        default: true
    secrets:
      REGISTRY_LOGIN:
        required: true
      REGISTRY_PASS:
        required: true
      ENV_FILE:
        required: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Project
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare Info
        id: info
        run: |
          # 1. Determine Version
          VERSION="${{ inputs.version }}"
          if [ -z "$VERSION" ] || [ "$VERSION" == "latest" ]; then
            git fetch --tags --force > /dev/null 2>&1
            LATEST_TAG=$(git tag --sort=-v:refname | head -n 1)
            if [ -z "$LATEST_TAG" ]; then
              VERSION="v0.0.1"
            else
              VERSION="$LATEST_TAG"
            fi
          fi
          
          # 2. Parse Service Config
          SERVICE_NAME=$(grep 'name:' service/configs/config.yaml | awk '{print $2}')
          [ -z "$SERVICE_NAME" ] && SERVICE_NAME="service"
          
          PORTS=$(grep 'addr:' service/configs/config.yaml | awk -F: '{print $NF}' | tr '\n' ' ' | xargs)
          [ -z "$PORTS" ] && PORTS="3000 3001"
          
          # 3. Clean Version & Time
          CLEAN_VERSION="${VERSION#v}"
          TIME_FMT=$(date +'%d-%m-%Y %H:%M')
          
          REGISTRY="registry.liftel.es:5000"
          IMAGE="${REGISTRY}/${SERVICE_NAME}:${CLEAN_VERSION}"
          
          echo "version=${CLEAN_VERSION}" >> $GITHUB_OUTPUT
          echo "timestamp=${TIME_FMT}" >> $GITHUB_OUTPUT
          echo "ports=${PORTS}" >> $GITHUB_OUTPUT
          echo "image=${IMAGE}" >> $GITHUB_OUTPUT
          echo "registry=${REGISTRY}" >> $GITHUB_OUTPUT

      - name: Create .env from secrets
        if: ${{ inputs.copy_env }}
        id: envfile
        env:
          SECRET_ENV: ${{ secrets.ENV_FILE }}
        run: |
          if [ -z "$SECRET_ENV" ]; then
            echo "Skipping .env creation (secret is empty)"
            echo "baked=false" >> $GITHUB_OUTPUT
          else
            echo "$SECRET_ENV" > .env
            echo "baked=true" >> $GITHUB_OUTPUT
          fi

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Docker Login
        uses: docker/login-action@v3
        with:
          registry: ${{ steps.info.outputs.registry }}
          username: ${{ secrets.REGISTRY_LOGIN }}
          password: ${{ secrets.REGISTRY_PASS }}

      - name: Generate Dockerfile
        run: |
          cat <<EOF > Dockerfile
          FROM golang:1.24 AS builder
          WORKDIR /src
          COPY service/ .
          RUN go mod download
          RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o /app/service ./cmd/service

          FROM gcr.io/distroless/static:nonroot
          WORKDIR /app
          COPY --from=builder /app/service .
          COPY service/configs/config.yaml /configs/config.yaml
          EOF
          
          # Conditionally add COPY .env
          if [ "${{ steps.envfile.outputs.baked }}" == "true" ]; then
             echo "COPY .env /app/.env" >> Dockerfile
          fi

          # Finish Dockerfile
          cat <<EOF >> Dockerfile
          EXPOSE ${{ steps.info.outputs.ports }}
          ENTRYPOINT ["/app/service"]
          CMD ["-conf", "/configs"]
          EOF

      - name: Build and Push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          push: true
          tags: ${{ steps.info.outputs.image }}
          provenance: false

      - name: Deploy Summary
        if: always()
        run: |
          echo "### ðŸ“¦ Deploy Info" > $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          echo "| **Time** | ${{ steps.info.outputs.timestamp }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | ${{ steps.info.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Image** | \`${{ steps.info.outputs.image }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Ports** | ${{ steps.info.outputs.ports }} |" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.envfile.outputs.baked }}" == "true" ]; then
             echo "| **.env** | âœ… Baked |" >> $GITHUB_STEP_SUMMARY
          else
             echo "| **.env** | âŒ Skipped |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then
             echo "âœ… **Build & Push Successful**" >> $GITHUB_STEP_SUMMARY
          else
             echo "âŒ **Build & Push Failed**" >> $GITHUB_STEP_SUMMARY
          fi
